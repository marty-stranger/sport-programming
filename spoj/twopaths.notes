some optimizations were required to fit into stack size limit
